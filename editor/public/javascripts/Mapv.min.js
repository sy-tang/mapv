!function(){"use strict";function Class(){this.__listeners={}}function DataRange(t){Class.call(this),this.initOptions({min:0,max:0}),this.set("layer",t),this.bindTo("data",t),this.bindTo("drawOptions",t),this.bindTo("drawType",t)}function Animation(t){var e={duration:1e3,fps:30,delay:0,transition:Transitions.linear,onStop:function(){}};if(this._anis=[],t)for(var a in t)e[a]=t[a];if(this._opts=e,"string"==typeof this._opts.transition&&(this._opts.transition=Transitions[this._opts.transition]||Transitions.linear),isNumber(e.delay)){var i=this;setTimeout(function(){i.start()},e.delay)}else e.delay!=Animation.INFINITE&&this.start()}function getCurrentTime(){return(new Date).getTime()}function isNumber(t){return"number"==typeof t}function SizeDataRange(){DataRange.call(this)}function TimeLine(t){Class.call(this)}function Mapv(t){Class.call(this),this.initOptions($.extend({map:null,drawTypeControl:!1,drawTypeControlOptions:{a:1},click:null,hover:null,tap:null},t)),this._layers=[],this._topLayer=null,this._container=this.getMap().getContainer(),this._initEvents(),this._fixPinchZoom(),this.notify("drawTypeControl")}function CanvasLayer(t){this.options=t||{},this.paneName=this.options.paneName||"labelPane",this.zIndex=this.options.zIndex||0,this.context=this.options.context||"2d",this._map=t.map,this.show()}function Layer(t){Class.call(this),this._drawer={},this.initOptions($.extend({ctx:null,animationCtx:null,mapv:null,paneName:"labelPane",map:null,context:"2d",data:[],dataType:"point",animationOptions:{size:5},coordType:"bd09ll",drawType:"simple",animation:!1,geometry:null,dataRangeControl:!0,zIndex:1},t)),this._highlightElement=null,this._id=Math.random(),this.dataRangeControl=new DataRangeControl,this.Scale=new DrawScale,this.notify("data"),this.notify("mapv")}function DataControl(t){this.initDom(),this.initEvent(),this["super"]=t,this.geoData=t.geoData}function DataRangeControl(){this.defaultAnchor=BMAP_ANCHOR_BOTTOM_RIGHT,this.defaultOffset=new BMap.Size(10,10)}function DrawScale(){this.defaultAnchor=BMAP_ANCHOR_BOTTOM_RIGHT,this.defaultOffset=new BMap.Size(10,10)}function drawTips(t){var e=t.left,a=t.right,i=t.top,n=t.ctx;n.beginPath(),n.moveTo(e+8,i-7),n.lineTo(a,i-7),n.lineTo(a,i+7),n.lineTo(e+8,i+7),n.lineTo(e,i),n.fill();var r=n.isPointInPath(t.sup.point.x,t.sup.point.y);r&&(t.sup.hoveredHandle=t),n.save(),n.fillStyle="white",n.fillText(t.text,e+8,i),n.restore()}function DrawTypeControl(t){Class.call(this),t=t||{},this.initOptions($.extend({mapv:null,drawTypeControlOptions:{},layer:null},t)),this.bindTo("drawTypeControlOptions",this.getMapv()),this.mapv=t.mapv,this.defaultAnchor=this.getDrawTypeControlOptions().anchor||BMAP_ANCHOR_TOP_RIGHT,this.defaultOffset=this.getDrawTypeControlOptions().offset||new BMap.Size(10,10)}function OptionalData(t){var e=t.options||{};this.drawType=e.drawType,this["super"]=t,this.options=e.drawOptions||{},this.initCSS(),this.initDom(),this.bindEvent()}function Drawer(t){Class.call(this),this.mapv=t._mapv,this.initOptions({layer:t,map:t.getMap(),ctx:null,mapv:null,animationOptions:{},drawOptions:{size:2},highlightElement:null}),this._elementPaths=[],this.dataRange=new DataRange(t),this.bindTo("ctx",t),this.bindTo("animationOptions",t),this.bindTo("drawOptions",t),this.bindTo("mapv",t),this.bindTo("map",t),this.bindTo("highlightElement",t)}function BubbleDrawer(){Drawer.apply(this,arguments)}function CategoryDrawer(){Drawer.apply(this,arguments)}function ChoroplethDrawer(){Drawer.apply(this,arguments)}function ClusterDrawer(){Drawer.apply(this,arguments)}function DensityDrawer(){this.Scale,this.masker={},Drawer.apply(this,arguments)}function recGrids(t,e){for(var a,i,n=t.data,r=t.nwMc,o=t.size,s=t.zoomUnit,l={},h=o/s,p=parseInt(r.x/o,10)*o,g=(p-r.x)/s,d=[],c=0;g+c*h<e.getSize().width;){var u=g+c*h;d.push(u.toFixed(2)),c++}for(var f=parseInt(r.y/o,10)*o+o,m=(r.y-f)/s,y=[],v=0;m+v*h<e.getSize().height;)u=m+v*h,y.push(u.toFixed(2)),v++;for(var w=0;w<d.length;w++)for(var x=0;x<y.length;x++){var _=d[w]+"_"+y[x];l[_]=0}for(var w=0;w<n.length;w++){var b=n[w].px,C=n[w].py,D=parseInt(n[w].count,10),T=b<d[0],S=C<y[0],M=b>Number(d[d.length-1])+Number(h),P=C>Number(y[y.length-1])+Number(h);if(!(T||S||M||P)){for(var x=0;x<d.length;x++){var O=Number(d[x]);if(b>=O&&O+h>b)for(var L=0;L<y.length;L++){var R=Number(y[L]);C>=R&&R+h>C&&(l[d[x]+"_"+y[L]]+=D,D=l[d[x]+"_"+y[L]])}}i=i||D,a=a||D,i=i>D?D:i,a=D>a?D:a}}return{grids:l,max:a,min:i}}function drawRec(t){var e=t.size,a=t.zoomUnit,i=t.max,n=t.min,r=t.ctx,o=t.grids,s=(t.fillColors,t.sup),l=formatParam.call(this),h=e/a,p=(i-n+1)/10;for(var g in o){var d=g.split("_"),c=d[0],u=d[1],f=((o[g]-n)/p,t.dataRange.getColorByGradient(o[g]));try{if(l.opacity){var m=parseInt(f.match(/rgba\(.+?\,.+?\,.+?\,(.+?)\)/)[1]*l.opacity)/255;f=f.replace(/(rgba\(.+?\,.+?\,.+?\,).+?(\))/,"$1"+m+"$2")}}catch(y){}var v=s.masker.min&&o[g]<s.masker.min,w=s.masker.max&&o[g]>s.masker.max;0===o[g]||v||w?r.fillStyle="rgba(255,255,255,0.1)":r.fillStyle=f,r.fillRect(c,u,h-1,h-1),s.getDrawOptions().label&&s.getDrawOptions().label.show&&(r.save(),r.textBaseline="top",0===o[g]||v||w||(r.fillStyle="rgba(0,0,0,0.8)",r.fillText(o[g],c,u)),r.restore())}}function honeycombGrid(t){var e,a,i=t.data,n=t.nwMc,r=t.size,o=t.zoomUnit,s=t.ctx,l={},h=r/o,p=h,g=3*h/4,d=2*r*3/4,c=parseInt(n.y/d+1,10)*d,u=(n.y-c)/o;u=parseInt(u,10);var f=parseInt(n.x/r,10)*r,m=(f-n.x)/o;m=parseInt(m,10);for(var y=parseInt(s.canvas.width+p,10),v=parseInt(s.canvas.height+g,10),w=m,x=u,_=!1;v>x;){for(;y>w;){var b=_?w-p/2:w;b=parseInt(b,10),l[b+"|"+x]=l[b+"|"+x]||{x:b,y:x,len:0},w+=p}_=!_,w=m,x+=g}for(var C in i){var D=i[C].count,T=i[C].px,S=i[C].py,M=Math.round((S-u)/g),P=M*g+u,O=Math.round((T-m)/p),L=O*p+m;if(M%2&&(L-=p/2),!(m>L||L>y||u>P||P>v)&&l[L+"|"+P]){l[L+"|"+P].len+=D;var R=l[L+"|"+P].len;e=e||R,a=a||R,e=Math.max(e,R),a=Math.min(a,R)}}return{grids:l,max:e,min:a}}function drawHoneycomb(t){var e=formatParam.call(this),a=t.ctx,i=t.grids,n=t.size/t.zoomUnit,r=t.fillColors,o=(t.max-t.min-1)/r.length,s=!1;for(var l in i){var h=i[l].x,p=i[l].y,g=i[l].len,d=g/o|0;d=d>=r.length?r.length-1:d,d=0>d?0:d;var c=t.dataRange.getColorByGradient(g);try{if(e.opacity){var u=parseInt(c.match(/rgba\(.+?\,.+?\,.+?\,(.+?)\)/)[1]*e.opacity)/255;c=c.replace(/(rgba\(.+?\,.+?\,.+?\,).+?(\))/,"$1"+u+"$2")}}catch(f){}var m=t.sup.masker.min&&t.sup.masker.min>g,y=t.sup.masker.max&&t.sup.masker.max<g;g>0&&!m&&!y?draw(h,p,n-1,c,a):s&&draw(h,p,n-1,"rgba(0,0,0,0.4)",a),t.sup.getDrawOptions().label&&t.sup.getDrawOptions().label.show&&!m&&!y&&(0!=g||0!=s)&&(a.save(),a.textBaseline="middle",a.textAlign="center",a.fillStyle="rgba(0,0,0,0.8)",a.fillText(g,h,p),a.restore())}}function draw(t,e,a,i,n){n.beginPath(),n.fillStyle=i,n.moveTo(t,e-a/2),n.lineTo(t+a/2,e-a/4),n.lineTo(t+a/2,e+a/4),n.lineTo(t,e+a/2),n.lineTo(t-a/2,e+a/4),n.lineTo(t-a/2,e-a/4),n.fill(),n.closePath()}function formatParam(){var t=this.getDrawOptions();t=JSON.stringify(t),t=JSON.parse(t);var e=this.fillColors=[[73,174,34],[119,191,26],[160,205,18],[202,221,10],[248,237,1],[225,222,3],[254,182,10],[254,126,19],[254,84,27],[253,54,32]],a=t.size||"50";return a+=t.unit||"px",a=/px$/.test(a)?parseInt(a,10)*this.zoomUnit:parseInt(a,10),t.size=a,t.colors=e,t}function HeatmapDrawer(){var t=this;t.masker={},Drawer.apply(this,arguments),this._max=20,this._data=[]}function IntensityDrawer(){this.masker={min:0,max:0},Drawer.apply(this,arguments),this._tmpCanvas=document.createElement("canvas")}function LineDrawer(){Drawer.apply(this,arguments)}function SimpleDrawer(){Drawer.apply(this,arguments)}var Mapv,util={isPlainObject:function(t){var e,a={},i=a.hasOwnProperty;if(!t||"object"!=typeof t||t.nodeType)return!1;var n=!i.call(t,"constructor"),r=!i.call(t.constructor.prototype,"isPrototypeOf");if(t.constructor&&n&&r)return!1;for(e in t);return void 0===e||i.call(t,e)},extend:function(t,e){var a,i=Object.prototype.toString,n="[object Array]";t=t||{};for(a in e)e.hasOwnProperty(a)&&(util.isPlainObject(e[a])?(t[a]=i.call(e[a])===n?[]:{},util.extend(t[a],e[a]),t[a]=e[a]):t[a]=e[a]);return t},copy:function(t){return this.extend({},t)},inherits:function(t,e){var a,i,n=t.prototype,r=new Function;r.prototype=e.prototype,i=t.prototype=new r;for(a in n)i[a]=n[a];t.prototype.constructor=t,t.superClass=e.prototype},addCssByStyle:function(t){var e=document,a=e.createElement("style");if(a.setAttribute("type","text/css"),a.styleSheet)a.styleSheet.cssText=t;else{var i=e.createTextNode(t);a.appendChild(i)}var n=e.getElementsByTagName("head");n.length?n[0].appendChild(a):e.documentElement.appendChild(a)},getGeoCenter:function(t){for(var e=t[0][0],a=t[0][1],i=t[0][0],n=t[0][1],r=1;r<t.length;r++)e=Math.min(e,t[r][0]),i=Math.max(i,t[r][0]),a=Math.min(a,t[r][1]),n=Math.max(n,t[r][1]);return[e+(i-e)/2,a+(n-a)/2]},getPixelRatio:function(t){var e=t.backingStorePixelRatio||t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1;return(window.devicePixelRatio||1)/e}},GeoUtil=function(){function t(t){var e=52.35987755982988,a=t.lng,i=t.lat,n=Math.sqrt(a*a+i*i)+2e-5*Math.sin(i*e),r=Math.atan2(i,a)+3e-6*Math.cos(a*e),o=n*Math.cos(r)+.0065,s=n*Math.sin(r)+.006;return{lng:o,lat:s}}function e(t){var e=52.35987755982988,a=t.lng-.0065,i=t.lat-.006,n=Math.sqrt(a*a+i*i)-2e-5*Math.sin(i*e),r=Math.atan2(i,a)-3e-6*Math.cos(a*e);return{lng:n*Math.cos(r),lat:n*Math.sin(r)}}function a(t){var e=3.141592653589793,a=6378245,i=.006693421622965943,n=t.lat,r=t.lng;if(o(r,n)){var h=s(r-105,n-35),p=l(r-105,n-35),g=n/180*e,d=Math.sin(g);d=1-i*d*d;var c=Math.sqrt(d);return h=180*h/(a*(1-i)/(d*c)*e),p=180*p/(a/c*Math.cos(g)*e),{lng:r+p,lat:n+h}}return{lng:r,lat:n}}function i(e){return t(a(e))}function n(t,e,a,i){this.west=Math.min(t,a),this.north=Math.max(e,i),this.east=Math.max(t,a),this.south=Math.min(e,i)}function r(t,e,a){return t.west<=e&&t.east>=e&&t.north>=a&&t.south<=a}function o(t,e){for(var a=0;a<h.length;a++)if(r(h[a],t,e)){for(var i=0;i<p.length;i++)if(r(p[i],t,e))return!1;return!0}return!1}function s(t,e){var a=3.141592653589793,i=-100+2*t+3*e+.2*e*e+.1*t*e+.2*Math.sqrt(Math.abs(t));return i+=2*(20*Math.sin(6*t*a)+20*Math.sin(2*t*a))/3,i+=2*(20*Math.sin(e*a)+40*Math.sin(e/3*a))/3,i+=2*(160*Math.sin(e/12*a)+320*Math.sin(e*a/30))/3}function l(t,e){var a=3.141592653589793,i=300+t+2*e+.1*t*t+.1*t*e+.1*Math.sqrt(Math.abs(t));return i+=2*(20*Math.sin(6*t*a)+20*Math.sin(2*t*a))/3,i+=2*(20*Math.sin(t*a)+40*Math.sin(t/3*a))/3,i+=2*(150*Math.sin(t/12*a)+300*Math.sin(t/30*a))/3}var h=[new n(79.4462,49.2204,96.33,42.8899),new n(109.6872,54.1415,135.0002,39.3742),new n(73.1246,42.8899,124.143255,29.5297),new n(82.9684,29.5297,97.0352,26.7186),new n(97.0253,29.5297,124.367395,20.414096),new n(107.975793,20.414096,111.744104,17.871542)],p=[new n(119.921265,25.398623,122.497559,21.785006),new n(101.8652,22.284,106.665,20.0988),new n(106.4525,21.5422,108.051,20.4878),new n(109.0323,55.8175,119.127,50.3257),new n(127.4568,55.8175,137.0227,49.5574),new n(131.2662,44.8922,137.0227,42.5692)];return{gcj_to_bd:t,bd_to_gcj:e,wgs_to_gcj:a,wgs_to_bd:i}}(),MVCObject;!function(){function t(t,e){var a=this;a.target=t,a.targetKey=e}t.prototype.transform=function(t,e){var a=this;return a.from=t,a.to=e,a.target.notify(a.targetKey),a},MVCObject=function(){function e(t){return t.substr(0,1).toUpperCase()+t.substr(1)}function a(t){return t[c]||(t[c]=++p)}function i(t){return"_"+t}function n(t){return l.hasOwnProperty(t)?l[t]:l[t]="get"+e(t)}function r(t){return h.hasOwnProperty(t)?h[t]:h[t]="set"+e(t)}function o(t,e){var a=e+"_changed";if(t[a]?t[a]():"function"==typeof t.changed&&t.changed(e),t[g]&&t[g][e]){var i,n,r=t[g][e];for(n in r)r.hasOwnProperty(n)&&(i=r[n],o(i.target,i.targetKey))}}function s(){}var l={},h={},p=0,g="__bindings__",d="__accessors__",c="__uid__",u=s.prototype;return u.get=function(t){var e=this;if(e[d]&&e[d].hasOwnProperty(t)){var a,r=e[d][t],o=r.targetKey,s=r.target,l=n(o);a=s[l]?s[l]():s.get(o),r.to&&(a=r.to(a))}else e.hasOwnProperty(i(t))&&(a=e[i(t)]);return a},u.set=function(t,e){var a=this;if(a[d]&&a[d].hasOwnProperty(t)){var n=a[d][t],s=n.targetKey,l=n.target,h=r(s);n.from&&(e=n.from(e)),l[h]?l[h](e):l.set(s,e)}else this[i(t)]=e,o(a,t);return a},u.changed=function(){},u.notify=function(t){var e=this;if(e[d]&&e[d].hasOwnProperty(t)){var a=e[d][t],i=a.targetKey,n=a.target;n.notify(i)}else o(e,t);return e},u.setValues=function(t){var e,a,i,n=this;for(e in t)t.hasOwnProperty(e)&&(i=t[e],a=r(e),n[a]?n[a](i):n.set(e,i));return n},u.setOptions=u.setValues,u.bindTo=function(e,i,n,r){n||(n=e);var s=this;s.unbind(e),s[d]||(s[d]={}),i[g]||(i[g]={}),i[g][n]||(i[g][n]={});var l=new t(s,e),h=new t(i,n);return s[d][e]=h,i[g][n][a(s)]=l,r||o(s,e),h},u.unbind=function(t){var e=this;if(e[d]){var n=e[d][t];if(n){var r=n.target,o=n.targetKey;e[i(t)]=e.get(t),delete r[g][o][a(e)],delete e[d][t]}}return e},u.unbindAll=function(){var t=this;if(t[d]){var e=t[d];for(var a in e)e.hasOwnProperty(a)&&t.unbind(a)}return t},u.initOptions=function(t){for(var e in t)this[n(e)]=function(t){return function(){return this.get(t)}}(e),this[r(e)]=function(t){return function(e){this.set(t,e)}}(e),this[i(e)]=t[e]},s}()}(),Mapv.MVCObject=MVCObject,util.inherits(Class,MVCObject),Class.prototype.addEventListener=function(t,e){return"object"!=typeof this.__listeners[t]&&(this.__listeners[t]=[]),this.__listeners[t].push(e),this},Class.prototype.removeEventListener=function(t,e){var a=this.__listeners[t];if(!a)return!1;for(var i=a.length;i>=0;i--)a[i]===e&&a.splice(i,1);return this},Class.prototype.dispatchEvent=function(t,e){var a=util.extend({},e),i=this.__listeners[t];if(!i)return!1;for(var n=i.length-1;n>=0;n--)i[n].call(this,a);return this},Class.prototype.dispose=function(){},util.inherits(DataRange,Class),util.extend(DataRange.prototype,{defaultGradient:{.4:"blue",.6:"cyan",.7:"lime",.8:"yellow","1.0":"red"},colors:["rgba(17, 102, 252, 0.8)","rgba(52, 139, 251, 0.8)","rgba(110, 176, 253, 0.8)","rgba(255, 241, 193, 0.8)","rgba(255, 146, 149, 0.8)","rgba(253, 98, 104, 0.8)","rgba(255, 0, 0, 0.8)","rgba(255, 51, 61, 0.8)"],getSize:function(t){for(var e=1,a=this.splitList,i=0;i<a.length;i++)if((void 0===a[i].start||void 0!==a[i].start&&t>=a[i].start)&&(void 0===a[i].end||void 0!==a[i].end&&t<a[i].end)){e=a[i].size;break}return e},getScale:function(t){return this._linearScale||(this._linearScale=this.generateLinearScale()),this._linearScale(t)},getColorByRange:function(t){for(var e="rgba(50, 50, 255, 1)",a=this.splitList,i=0;i<a.length;i++)if((void 0===a[i].start||void 0!==a[i].start&&t>=a[i].start)&&(void 0===a[i].end||void 0!==a[i].end&&t<a[i].end)){e=a[i].color;break}return e},data_changed:function(){var t=this.get("data");if(t&&t.length>0){this._min=t[0].count,this._max=t[0].count;for(var e=0;e<t.length;e++)this._max=Math.max(this._max,t[e].count),this._min=Math.min(this._min,t[e].count)}},drawType_changed:function(){this.update()},drawOptions_changed:function(){this.update()},update:function(){var t=this.get("drawOptions");t&&t.splitList?this.splitList=t.splitList:this.generalSplitList(),"category"===this.get("layer").getDrawType()&&(t&&t.splitList?this.categorySplitList=t.splitList:this.generalCategorySplitList()),("heatmap"===this.get("layer").getDrawType()||"density"===this.get("layer").getDrawType()||"intensity"===this.get("layer").getDrawType())&&this.generalGradient(t.gradient||this.defaultGradient),this.draw()},draw:function(){this.get("layer").getDataRangeControl()&&this.get("layer").dataRangeControl.show(),"bubble"===this.get("layer").getDrawType()?this.get("layer").dataRangeControl.drawSizeSplit(this.splitList,this.get("drawOptions")):"category"===this.get("layer").getDrawType()?this.get("layer").dataRangeControl.drawCategorySplit(this.categorySplitList,this.get("drawOptions")):"choropleth"===this.get("layer").getDrawType()?this.get("layer").dataRangeControl.drawChoroplethSplit(this.splitList,this.get("drawOptions")):this.get("layer").dataRangeControl.hide()},generateLinearScale:function(){var t=this.get("drawOptions"),e=t.scaleRange||[.5,1.5];return function(t){return this._min==this._max?1:e[0]+(e[1]-e[0])*(t-this._min)/(this._max-this._min)}},generalSplitList:function(){var t=this.get("drawOptions"),e=util.extend({minSize:1,maxSize:9999,stepSize:1,splitCount:7},t.splitOptions),a=Math.ceil((this._max-this._min)/e.splitCount),i=this._min;this.splitList=[];for(var n=e.minSize;i<this._max;)this.splitList.push({start:i,end:i+a,size:n,color:this.colors[n-1]}),i+=a,n=Math.min(n+e.stepSize,e.maxSize)},generalCategorySplitList:function(){var t=["rgba(255, 255, 0, 0.8)","rgba(253, 98, 104, 0.8)","rgba(255, 146, 149, 0.8)","rgba(255, 241, 193, 0.8)","rgba(110, 176, 253, 0.8)","rgba(52, 139, 251, 0.8)","rgba(17, 102, 252, 0.8)"],e=this.get("data");this.categorySplitList={};for(var a=0,i=0;i<e.length&&(void 0===this.categorySplitList[e[i].count]&&(this.categorySplitList[e[i].count]=t[a],a++),!(a>=t.length-1));i++);this.categorySplitList.other=t[t.length-1]},getCategoryColor:function(t){var e=this.categorySplitList,a=e.other;for(var i in e)if(t==i){a=e[i];break}return a},generalGradient:function(t){var e=document.createElement("canvas"),a=e.getContext("2d"),i=a.createLinearGradient(0,0,0,256);e.width=1,e.height=256;for(var n in t)i.addColorStop(n,t[n]);a.fillStyle=i,a.fillRect(0,0,1,256),this._grad=a.getImageData(0,0,1,256).data},getGradient:function(){return this._grad},getColorByGradient:function(t){var e=this.get("max")||10,a=t/e;a>1&&(a=1),a*=255,a=parseInt(a,10),a*=4;var i="rgba("+this._grad[a]+", "+this._grad[a+1]+", "+this._grad[a+2]+","+this._grad[a+3]+")";return i}}),Animation.INFINITE="INFINITE",Animation.prototype.start=function(){this._beginTime=getCurrentTime(),this._endTime=this._beginTime+this._opts.duration,this._launch()},Animation.prototype.add=function(t){this._anis.push(t)},Animation.prototype._launch=function(){var t=this,e=getCurrentTime();if(e>=t._endTime){if(t._opts.render&&t._opts.render(t._opts.transition(1)),t._opts.finish&&t._opts.finish(),t._anis.length>0){var a=t._anis[0];a._anis=[].concat(t._anis.slice(1)),a.start()}}else t.schedule=t._opts.transition((e-t._beginTime)/t._opts.duration),t._opts.render&&t._opts.render(t.schedule),t.terminative||(t._timer=setTimeout(function(){t._launch()},1e3/t._opts.fps))},Animation.prototype.stop=function(t){this.terminative=!0;for(var e=0;e<this._anis.length;e++)this._anis[e].stop(),this._anis[e]=null;this._anis.length=0,this._timer&&(clearTimeout(this._timer),this._timer=null),this._opts.onStop(this.schedule),t&&(this._endTime=this._beginTime,this._launch())},Animation.prototype.cancel=function(){this._timer&&clearTimeout(this._timer),this._endTime=this._beginTime,this.schedule=0},Animation.prototype.setFinishCallback=function(t){this._anis.length>0?this._anis[this._anis.length-1]._opts.finish=t:this._opts.finish=t};var Transitions={linear:function(t){return t},reverse:function(t){return 1-t},easeInQuad:function(t){return t*t},easeInCubic:function(t){return Math.pow(t,3)},easeOutQuad:function(t){return-(t*(t-2))},easeOutCubic:function(t){return Math.pow(t-1,3)+1},easeInOutQuad:function(t){return.5>t?t*t*2:-2*(t-2)*t-1},easeInOutCubic:function(t){return.5>t?4*Math.pow(t,3):4*Math.pow(t-1,3)+1},easeInOutSine:function(t){return(1-Math.cos(Math.PI*t))/2}};Transitions["ease-in"]=Transitions.easeInQuad,Transitions["ease-out"]=Transitions.easeOutQuad,util.inherits(SizeDataRange,DataRange),util.extend(SizeDataRange.prototype,{}),util.inherits(TimeLine,Class),util.extend(TimeLine.prototype,{});var timeLine=new TimeLine({});util.inherits(Mapv,Class),Mapv.prototype._initDrawScale=function(){this.Scale=new DrawScale},Mapv.prototype.drawTypeControl_changed=function(){this.getDrawTypeControl()?(this.drawTypeControl||(this.drawTypeControl=new DrawTypeControl({mapv:this})),this.getMap().addControl(this.drawTypeControl)):this.drawTypeControl&&this.getMap().removeControl(this.drawTypeControl)},Mapv.prototype._initEvents=function(){var t=this.getMap(),e=this,a=[],i=function(t){for(var i=this.getBoundingClientRect(),n=t.clientX-i.left,r=t.clientY-i.top,o=e._layers,s=[],l=e._getHandler(t.type),h=0;h<o.length;h++){var p=o[h],g=p.findElementAtPoint(n,r);if(g){s.push(g.data);break}}("mousemove"!=t.type||0!=a.length||0!=s.length)&&(a=s,l&&"function"==typeof l&&l(s,t))};if(this._getHandler("click")){t.getContainer().addEventListener("click",i);var n=!1,r=0,o=0,s=0,l=0;t.addEventListener("touchstart",function(t){var e=t.targetTouches[0];r=s=e.clientX,o=l=e.clientY,n=!0;var a=this;!function(t){setTimeout(function(){if(s==r&&!n&l==o){var t=document.createEvent("Event");t.initEvent("tap",!0,!0),t.clientX=s,t.clientY=l,i.call(a.getContainer(),t)}},200)}(t)}),t.addEventListener("touchend",function(t){n=!1}),t.addEventListener("touchmove",function(t){var e=t.changedTouches[0];r=e.clientX,o=e.clientY})}this._getHandler("hover")&&t.getContainer().addEventListener("mousemove",i)},Mapv.prototype._fixPinchZoom=function(){var t,e=this.getMap(),a=e.getZoom(),i=e.getContainer().getBoundingClientRect();e.addEventListener("touchstart",function(a){if(2==a.targetTouches.length){var n=a.targetTouches,r={x:(n[0].clientX+n[1].clientX)/2-i.left,y:(n[0].clientY+n[1].clientY)/2-i.top};t=e.pixelToPoint(r)}}),e.addEventListener("touchcancel",function(e){t=null}),e.addEventListener("zoomend",function(i){var n=e.getZoom();n>a&&t&&e.panTo(t),a=n,t=null})},Mapv.prototype._getHandler=function(t){switch(t){case"tap":case"click":return this.getClick();case"hover":case"mousemove":return this.getHover();default:return null}},Mapv.prototype.addLayer=function(t){t&&(this._layers.push(t),this._topLayer=t)},CanvasLayer.prototype=new BMap.Overlay,CanvasLayer.prototype.initialize=function(t){this._map=t;var e=this.canvas=document.createElement("canvas");e.style.cssText="position:absolute;left:0;top:0;z-index:"+this.zIndex+";",this.adjustSize(),t.getPanes()[this.paneName].appendChild(e);var a=this;return t.addEventListener("resize",function(){a.adjustSize(),a.draw()}),this.canvas},CanvasLayer.prototype.adjustSize=function(){var t,e=this._map.getSize(),a=this.canvas;t="webgl"==this.context?1:util.getPixelRatio(a.getContext("2d")),a.width=e.width*t,a.height=e.height*t,a.style.width=e.width+"px",a.style.height=e.height+"px"},CanvasLayer.prototype.draw=function(){var t=this._map,e=t.getSize(),a=t.getCenter();if(a){var i=t.pointToOverlayPixel(a);this.canvas.style.left=i.x-e.width/2+"px",this.canvas.style.top=i.y-e.height/2+"px",this.dispatchEvent("draw"),this.options.update&&this.options.update.call(this)}},CanvasLayer.prototype.getContainer=function(){return this.canvas},CanvasLayer.prototype.show=function(){this.canvas||this._map.addOverlay(this),this.canvas.style.display="block"},CanvasLayer.prototype.hide=function(){this.canvas.style.display="none"},CanvasLayer.prototype.setZIndex=function(t){this.canvas.style.zIndex=t},CanvasLayer.prototype.getZIndex=function(){return this.zIndex},util.inherits(Layer,Class),util.extend(Layer.prototype,{initialize:function(){if(!this.canvasLayer){this.bindTo("map",this.getMapv());var t=this;this.getMap().addControl(this.dataRangeControl),this.getMap().addControl(this.Scale),this.canvasLayer=new CanvasLayer({map:this.getMap(),context:this.getContext(),zIndex:this.getZIndex(),paneName:this.getPaneName(),update:function(){t.draw()},elementTag:"canvas"}),this.setCtx(this.canvasLayer.getContainer().getContext(this.getContext())),this.getAnimation()&&"polyline"==this.getDataType()&&(this.animationLayer=new CanvasLayer({map:this.getMap(),zIndex:this.getZIndex(),elementTag:"canvas"}),this.setAnimationCtx(this.animationLayer.getContainer().getContext(this.getContext())))}},draw:function(t){var e=this;if(this.getMapv()){var a=this.getCtx();if(!a)return!1;t||this._calculatePixel(),(!this.getAnimation()||this._animationTime)&&("2d"==this.getContext()&&a.clearRect(0,0,a.canvas.width,a.canvas.height),this._getDrawer().drawMap());var i=this.getAnimationOptions()||{};if("polyline"===this.getDataType()&&this.getAnimation()&&!this._animationTime)if(this._animationTime=!0,"time"==this.getAnimation){var n=this.timeline=new Animation({duration:i.duration||1e4,fps:i.fps||30,delay:i.delay||Animation.INFINITE,transition:Transitions[i.transition||"linear"],onStop:i.onStop||function(t){},render:function(t){"2d"==e.getContext()&&a.clearRect(0,0,a.canvas.width,a.canvas.height);var n=parseInt(parseFloat(e._minTime)+(e._maxTime-e._minTime)*t);e._getDrawer().drawMap(n),i.render&&i.render(n)}});n.setFinishCallback(function(){n.start()}),n.start()}else"2d"==this.getContext()&&a.clearRect(0,0,a.canvas.width,a.canvas.height),this._getDrawer().drawMap(),this.drawAnimation();if(("bubble"===this.getDrawType()||"simple"===this.getDrawType())&&this.getAnimation()&&!this._animationTime){this._animationTime=!0;var n=this.timeline=new Animation({duration:i.duration||1e3,fps:i.fps||30,delay:i.delay||Animation.INFINITE,transition:Transitions[i.transition||"linear"],onStop:i.onStop||function(t){},render:function(t){"2d"==e.getContext()&&a.clearRect(0,0,a.canvas.width,a.canvas.height),e._getDrawer().drawMap(t),i.render&&i.render(time)}});n.start()}if(this.getAnimation()&&!this._animationTime&&this.getDrawOptions().icon){this._animationTime=!0,"2d"==this.getContext()&&a.clearRect(0,0,a.canvas.width,a.canvas.height),this._getDrawer().drawMap();var r=e.canvasLayer.getContainer();r.style.transform="translate(0, -100)",r.style.opacity=0;var n=this.timeline=new Animation({duration:i.duration||1e3,fps:i.fps||30,delay:i.delay||Animation.INFINITE,transition:Transitions[i.transition||"linear"],onStop:i.onStop||function(t){},render:function(t){var a=100*-(1-t),n=e.canvasLayer.getContainer();n.style.transform="translate(0, "+a+"px)",n.style.opacity=t,i.render&&i.render(time)}});n.start()}return this.dispatchEvent("draw"),!0}},drawAnimation:function(){var t=this.getAnimationCtx();if(!t)return!1;t.clearRect(0,0,t.canvas.width,t.canvas.height);var e=this;this._getDrawer().drawAnimation(),this.getAnimation()&&requestAnimationFrame(function(){e.drawAnimation()})},animation_changed:function(){this.getAnimation()&&this.drawAnimation()},mapv_changed:function(){return this.getMapv()?(this.canvasLayer&&this.canvasLayer.show(),this.initialize(),this.updateControl(),this.draw(),void this.getMapv().addLayer(this)):void(this.canvasLayer&&this.canvasLayer.hide())},drawType_changed:function(){this.updateControl(),this.draw()},drawOptions_changed:function(){this.draw()},updateControl:function(){var t=this.getMapv();if(t){var e=this._getDrawer();this.getMap();e.scale&&this.getDataRangeControl()?(e.scale(this.Scale),this.Scale.show()):this.Scale.hide(),this.getMapv().OptionalData&&this.getMapv().OptionalData.initController(this,this.getDrawType())}},_getDrawer:function _getDrawer(){var drawType=this.getDrawType();if(!this._drawer[drawType]){var funcName=drawType.replace(/(\w)/,function(t){return t.toUpperCase()});funcName+="Drawer";var drawer=this._drawer[drawType]=eval("(new "+funcName+"(this))");drawer.scale?this.getMapv()&&(drawer.scale(this.Scale),this.Scale.show()):this.Scale.hide()}return this._drawer[drawType]},_calculatePixel:function(){for(var t=this.getMapv().getMap(),e=t.getMapType().getProjection(),a=t.getZoom(),i=Math.pow(2,18-a),n=e.lngLatToPoint(t.getCenter()),r=new BMap.Pixel(n.x-t.getSize().width/2*i,n.y+t.getSize().height/2*i),o=this.getData(),t=this.getMap(),s=0;s<o.length;s++){if(o[s].lng&&o[s].lat&&!o[s].x&&!o[s].y){var l=e.lngLatToPoint(new BMap.Point(o[s].lng,o[s].lat));o[s].x=l.x,o[s].y=l.y}if(o[s].x&&o[s].y&&(o[s].px=(o[s].x-r.x)/i,o[s].py=(r.y-o[s].y)/i),o[s].geo){var h=[];if("bd09ll"===this.getCoordType())for(var p=0;p<o[s].geo.length;p++){var l=t.pointToPixel(new BMap.Point(o[s].geo[p][0],o[s].geo[p][1]));h.push([l.x,l.y,parseFloat(o[s].geo[p][2])])}else if("bd09mc"===this.getCoordType())for(var p=0;p<o[s].geo.length;p++)h.push([(o[s].geo[p][0]-r.x)/i,(r.y-o[s].geo[p][1])/i,parseFloat(o[s].geo[p][2])]);o[s].pgeo=h}}},data_changed:function(){var t=this.getData();if(t){if("gcj-02"==this.getCoordType())for(var e=0;e<t.length;e++){var a=GeoUtil.gcj_to_bd(t[e]);t[e].lng=a.lng,t[e].lat=a.lat}if("wgs-84"==this.getCoordType())for(var e=0;e<t.length;e++){var a=GeoUtil.wgs_to_bd(t[e]);t[e].lng=a.lng,t[e].lat=a.lat}if("bubble"===this.getDrawType()&&t.sort(function(t,e){return e.count-t.count}),"polyline"===this.getDataType()&&this.getAnimation())for(var e=0;e<t.length;e++)t[e].index=parseInt(Math.random()*t[e].geo.length,10);if("polyline"===this.getDataType()&&"time"===this.getAnimation()){this._minTime=t[0]&&t[0].geo[0][2],this._maxTime=this._minTime;for(var e=0;e<t.length;e++)for(var i=t[e].geo,n=0;n<i.length;n++){var r=i[n][2];r<this._minTime&&(this._minTime=r),r>this._maxTime&&(this._maxTime=r)}}t.length>0&&(this._min=t[0].count,this._max=this._max);for(var e=0;e<t.length;e++)(void 0===t[e].count||null===t[e].count)&&(t[e].count=1),this._max=Math.max(this._max,t[e].count),this._min=Math.min(this._min,t[e].count);this.draw()}},getDataRange:function(){return{minTime:this._minTime,maxTime:this._maxTime,min:this._min,max:this._max}},zIndex_changed:function(){var t=this.getZIndex();this.canvasLayer.setZIndex(t)},dataRangeControl_changed:function(){this.updateControl(),this._getDrawer().notify("drawOptions")},highlightElement_changed:function(){"simple"==this.getDrawType()&&this.getDrawOptions().icon||this.draw(!0)},findElementAtPoint:function(t,e){var a=this._getDrawer();if(a){var i=a.getElementPaths(),n=this.getCtx(),r=this.getData();if(this._highlightElement&&n.isPointInPath(i[this._highlightElement.index],t,e))return this._highlightElement;for(var o=null,s=0;s<i.length;s++)if(n.isPointInPath(i[s],t,e)){var r=this.getData();o={index:s,data:r[s]};break}return this._highlightElement!==o&&(this._highlightElement=o,this.notify("highlightElement")),o}},_getHandler:function(t){return"click"==t?this.getClick():"hover"==t?this.getHover():"tap"==t?this.getTap():null},getCanvas:function(){return this.canvasLayer?this.canvasLayer.getContainer():null}}),DataControl.prototype.initDom=function(){var t=this.control=document.createElement("div"),e=this.input=document.createElement("input");e.type="file";var a=document.createElement("div");a.textContent="自定义数据：";var i=document.createElement("div");i.textContent="拖拽文件到窗口或者选择自定义文件",t.appendChild(a),t.appendChild(i),t.appendChild(e),t.style.fontSize="12px",t.style.lineHeight="1.8em",t.style.position="absolute",t.style.bottom="50px",t.style.left="10px",t.style.padding="10px 20px",t.style.color="#FFF",t.style.background="rgba(0,0,0,0.5)",t.style.zIndex="100000",t.style.overflow="hidden",t.style.webkitTransition="all 0.5s ease-in";var n=document.createElement("div"),r=document.createElement("div");r.textContent="历史数据",this.history=document.createElement("div"),n.appendChild(r),n.appendChild(this.history),t.appendChild(n),document.body.appendChild(t)},DataControl.prototype.initEvent=function(){function t(t){var a,i=!1;try{a=JSON.parse(t.replace(/\s/g,""));for(var n=0;"string"==typeof a&&10>=n;)a=JSON.parse(a),n++;i=!1}catch(r){i=!0}if(i)try{a=[];var o=t.split("\n");o.length<=1&&(o=t.split("\\n"));for(var s=o[0].split(","),l=1;l<s.length;l++){for(var h=o[l].split(","),p={},g=0,d=0;d<h.length;d++){var c=s[d]||"noname"+g++;c=c.replace(/\\r/g,""),p[c]=Number(h[d].replace(/\\r/g,"").replace(/\"/g,""))}a.push(p)}a=JSON.stringify(a).replace(/\\r/g,""),a=JSON.parse(a),i=!1}catch(r){i=!0}if(i)return!1;e.geoData.setData(a);for(var l=0;l<e["super"]._layers.length;l++)e["super"]._layers[l].draw();return!0}var e=this,a=new FileReader;a.addEventListener("load",function(i){var n=a.result,r=t(n);if(r){var o=localStorage.getItem("filenames")||"{}";if(o=JSON.parse(o),!a.fileName||!a.fileSize)return!1;for(var s in o)if(o[s].name===this.fileName&&o[s].size===this.fileSize)return!1;var l=this.fileName+this.fileSize+parseInt(1e17*Math.random(),10).toString(36);o[l]={size:this.fileSize,name:this.fileName},localStorage.setItem("filenames",JSON.stringify(o)),localStorage.setItem(l,JSON.stringify(n)),
e.initHistory()}}),e.history.addEventListener("click",function(e){var a=e.target;if("A"===a.nodeName){var i=a.getAttribute("storageName"),n=localStorage.getItem(i);t(n)}return!1}),e.input.addEventListener("change",function(t){a.readAsText(t.target.files[0]),a.fileName=t.target.files[0].name,a.fileSize=t.target.files[0].size}),document.addEventListener("dragover",function(t){t.preventDefault()},!1),document.addEventListener("drop",function(t){return t.preventDefault(),a.readAsText(t.dataTransfer.files[0]),a.fileName=t.dataTransfer.files[0].name,a.fileSize=t.dataTransfer.files[0].size,!1})},DataRangeControl.prototype=new BMap.Control,util.extend(DataRangeControl.prototype,{initialize:function(t){var e=this.canvas=document.createElement("canvas");return e.style.background="#fff",e.style.boxShadow="rgba(0,0,0,0.2) 0 0 4px 2px",e.style.border="1px solid #999999",e.style.borderRadius="4px",t.getContainer().appendChild(e),e},getContainer:function(){return this.canvas},drawSizeSplit:function(t,e){var a=this.canvas;a.width=100,a.height=190,a.style.width="100px",a.style.height="190px";for(var i=a.getContext("2d"),n=10,r=0,o=0;o<t.length;o++)t[o].size>r&&(r=t[o].size);for(var o=0;o<t.length;o++){n+=t[o].size,i.beginPath(),i.arc(r+5,n,t[o].size,0,2*Math.PI,!1);var s=t[o].start||"~",l=t[o].end||"~",h=s+" - "+l;i.closePath(),i.fillStyle=e.fillStyle||"rgba(50, 50, 200, 0.8)",i.fill(),i.fillStyle="rgba(30, 30, 30, 1)",i.fillText(h,2*r+10,n+6);var p=t[o].size+5;15>p&&(p=15),n+=p}},drawCategorySplit:function(t,e){var a=this.canvas;a.width=80,a.height=190,a.style.width="80px",a.style.height="190px";var i=a.getContext("2d"),n=0;for(var r in t)i.fillStyle=t[r],i.beginPath(),i.arc(15,25*n+15,5,0,2*Math.PI,!1),i.closePath(),i.fill(),i.fillStyle="#333",i.fillText(r,25,25*n+20),n++},drawChoroplethSplit:function(t,e){var a=this.canvas;a.width=100,a.height=190,a.style.width="100px",a.style.height="190px";var i=a.getContext("2d");i.fillStyle=e.fillStyle||"rgba(50, 50, 200, 0.8)";for(var n=0;n<t.length;n++){i.beginPath(),i.arc(15,25*n+15,5,0,2*Math.PI,!1);var r=(t[n].start||"~")+" - "+(t[n].end||"~");i.closePath(),i.fillStyle=t[n].color,i.fill(),i.fillStyle="#333",i.fillText(r,25,25*n+20)}},hide:function(){this.canvas&&(this.canvas.style.display="none")},show:function(){this.canvas&&(this.canvas.style.display="block")}}),DrawScale.prototype=new BMap.Control,DrawScale.prototype.change=function(t){var e=this;e.changeFn=t},DrawScale.prototype.hide=function(){var t=this;t.box&&(t.box.style.display="none")},DrawScale.prototype.show=function(){var t=this;t.box&&(t.box.style.display="block")},DrawScale.prototype.set=function(t){var e=this;e.max=t.max||e.max,e.min=t.min||e.min,e.colors=t.colors||e.colors,e._draw()},DrawScale.prototype.initialize=function(t){var e=this;e.changeFn=null,e.width=55,e.height=250,e.min=0,e.max=100,e.offsetTop=10,e.offsetBottom=10,e.drawHeight=e.height-e.offsetTop-e.offsetBottom,e.colors=["#49ae22","#77c01a","#a0cd12","#cadd0a","#f8ed01","#e1de03","#feb60a","#fe7e13","#fe571b","#fd3620"],e.defaultColors=["#49ae22","#77c01a","#a0cd12","#cadd0a","#f8ed01","#e1de03","#feb60a","#fe7e13","#fe571b","#fd3620"],e.point={x:0,y:0},e.hoveredHandle=null,e.showHandle=!1,e.handleStartPos={val:e.min,yMin:e.offsetTop,yMax:e.offsetTop+e.drawHeight,y:e.offsetTop},e.handleEndPos={val:e.max,yMin:e.offsetTop,yMax:e.offsetTop+e.drawHeight,y:e.offsetTop+e.drawHeight};var a=e.box=document.createElement("div"),i=document.createElement("canvas");return i.width=e.width,i.height=e.height,i.style.cursor="pointer",a.style.border="1px solid #999",a.style.boxShadow="rgba(0, 0, 0, 0.2) 0px 0px 4px 2px",a.style.borderRadius="6px",a.style.background="white",a.style.position="absolute",a.style.width=e.width+"px",a.style.height=e.height+"px",a.style.zIndex=1e4,a.appendChild(i),t.getContainer().appendChild(a),e.ctx=i.getContext("2d"),e._draw(),this._Event(),a},DrawScale.prototype._Event=function(){var t=this,e=t.ctx.canvas,a=!1,i={x:0,y:0},n={y:0,name:null};e.addEventListener("mouseenter",function(){t.showHandle=!0,t._draw()}),e.addEventListener("mouseleave",function(){t.showHandle=!1,t._draw()}),e.addEventListener("mousedown",function(e){var r=t.hoveredHandle;if(r){i.x=e.pageX,i.y=e.pageY;var o="handle"+r.name+"Pos";n.name=o,n.y=t[o].y,a=!0}}),window.addEventListener("mousemove",function(e){if(t.point.x=e.offsetX,t.point.y=e.offsetY,a){var r=e.pageY-i.y;t[n.name].y=n.y+r;var o=n.y+r,s=t[n.name].yMax,l=t[n.name].yMin;o=o>s?s:o,o=l>o?l:o,t[n.name].y=o,"handleStartPos"===n.name&&(t.handleEndPos.yMin=o),"handleEndPos"===n.name&&(t.handleStartPos.yMax=o),e.preventDefault()}t._draw()}),window.addEventListener("mouseup",function(e){a&&(t.changeFn&&t.changeFn(t.handleStartPos.val,t.handleEndPos.val),a=!1)})},DrawScale.prototype._draw=function(){var t=this,e=t.ctx;if(e){e.clearRect(0,0,e.canvas.width,e.canvas.height),t.hoveredHandle=null;var a,i=5,n=t.offsetTop,r=10,o=t.drawHeight;a="default"===t.colors?t.defaultColors:t.colors;var s=e.createLinearGradient(i,n,r,o),l=o/(a.length-1);if(t.colors instanceof Array||"default"===t.colors)for(var h=0;h<a.length;h++){var p=h*l/t.height;s.addColorStop(p,a[h])}else if("object"==typeof t.colors)for(var h in t.colors)s.addColorStop(h,t.colors[h]);e.fillStyle=e.strokeStyle=s,e.fillRect(i,n,r,o);var g=(t.handleStartPos.y-n)/o*t.max|0,d=t.handleStartPos.val=g+t.min,c=t.handleEndPos.val=(t.handleEndPos.y-n)/o*t.max|0;e.textAlign="left",e.textBaseline="middle";var u=i+r+5;e.fillText("- "+t.min,u,n),e.fillText("- "+t.max,u,n+o),e.save(),e.fillStyle="grey",t.handleStartPos.y>n+10&&e.fillText("- "+d,u,t.handleStartPos.y),t.handleEndPos.y<n+o-10&&e.fillText("- "+c,u,t.handleEndPos.y),e.restore(),t.showHandle&&(drawTips({sup:t,name:"Start",ctx:e,left:i+r,right:e.canvas.width-5,top:t.handleStartPos.y,text:d}),drawTips({sup:t,name:"End",ctx:e,left:i+r,right:e.canvas.width-5,top:t.handleEndPos.y,text:c})),e.save(),e.fillStyle="#ADABAB";var f=i,m=r;e.fillRect(f,n,m,t.handleStartPos.y-t.offsetTop),e.fillRect(f,t.handleEndPos.y,m,o-t.handleEndPos.y+t.offsetTop),e.restore(),t.hoveredHandle?e.canvas.style.cursor="pointer":e.canvas.style.cursor="default"}},util.addCssByStyle(["#MapvDrawTypeControl { list-style:none; position:absolute; right:0px; top:0px; bottom:0px; padding:0; margin:0;","border-radius: 5px; overflow: hidden; border: 1px solid rgb(153, 153, 153); box-shadow: rgba(0, 0, 0, 0.2) 0px 0px 4px 2px;}","#MapvDrawTypeControl li{ padding:0; margin:0; cursor:pointer; ","color:#333; padding:5px; background:rgba(255, 255, 255, 1); border-bottom: 1px solid #aaa;}","#MapvDrawTypeControl li.current{ background:#999; color:#fff;}"].join("\n")),util.inherits(DrawTypeControl,Class),util.inherits(DrawTypeControl,BMap.Control),DrawTypeControl.prototype.initialize=function(t){var e=this.ul=document.createElement("ul");e.setAttribute("id","MapvDrawTypeControl");var a=this;return e.addEventListener("click",function(t){var e=t.target;if("LI"===e.nodeName){for(var i=e.parentNode,n=i.getElementsByTagName("li"),r=0;r<n.length;r++)n[r].className="";var o=e.getAttribute("drawType");e.className="current",a.getDrawTypeControlOptions().drawOptions&&a.getDrawTypeControlOptions().drawOptions[o]&&a.layer.setDrawOptions(a.getDrawTypeControlOptions().drawOptions[o]),a.layer.setDrawType(o)}}),this.showLayer(),t.getContainer().appendChild(e),e},DrawTypeControl.prototype.getContainer=function(){return this.ul},DrawTypeControl.prototype.drawTypeControlOptions_changed=function(){this.layer=this.getDrawTypeControlOptions().layer,this.layer&&(this.showLayer(),void 0!==this.getDrawTypeControlOptions().anchor&&this.setAnchor(this.getDrawTypeControlOptions().anchor),void 0!==this.getDrawTypeControlOptions().offset&&this.setOffset(this.getDrawTypeControlOptions().offset))},DrawTypeControl.prototype.showLayer=function(){if(this.layer){var t=this.ul;t.innerHTML="";for(var e=["simple","heatmap","density","bubble","category","choropleth","intensity","cluster"],a=0;a<e.length;a++){var i=e[a],n=document.createElement("li");this.layer.getDrawType()===i&&(n.className="current"),n.setAttribute("drawType",i),n.innerHTML=i,t.appendChild(n)}}},OptionalData.prototype.initCSS=function(){util.addCssByStyle([".controlBox { position:absolute; left:0px; top:0px; background:rgba(0,0,0,0.5); padding:10px; }",".controlBox input {border-radius:6px; border:none; padding:10px;}",".controlBox button ","{ padding:8px 10px; border:none; width:40%; margin-left: 10px; border-radius:6px; cursor:pointer; }",".controlBoxBlock { color:#fff; padding: 10px; }",".controlBoxTitle { display:inline-block; width:100px; text-align:right; padding-right:10px; }"].join("\n"))},OptionalData.prototype.initDom=function(){var t=this.box=document.createElement("div");t.className="controlBox";var e=this.contentBox=document.createElement("div"),a=document.createElement("div");a.style.textAlign="center";var i=this.updateBtn=document.createElement("button"),n=this.resetBtn=document.createElement("button");return i.textContent="update",n.textContent="reset",t.appendChild(e),a.appendChild(i),a.appendChild(n),t.appendChild(a),document.body.appendChild(t),t},OptionalData.prototype.initController=function(t,e){return!1},OptionalData.prototype.bindEvent=function(){var t=this;this.updateBtn.onclick=function(){for(var e=0;e<t.options.editable.length;e++){var a=t.options.editable[e].name,i=t.contentBox.querySelector('input[name="'+a+'"]');i&&("radio"===i.type?(i=t.contentBox.querySelector('input[name="'+a+'"]:checked'),t.options[a]=i.value):"checkbox"===i.type?(i=t.contentBox.querySelector('input[name="'+a+'"]'),t.options[a]=i.checked):"true"===i.getAttribute("isJson")?t.options[a]=JSON.parse(i.value):t.options[a]=i.value)}var n=t._layer._getDrawer(t.drawType);n.setDrawOptions(t.options),t._layer.draw()},this.resetBtn.onclick=function(){for(var e=0;e<t.options.editable.length;e++){var a=t.options.editable[e].name,i=t.options.editable[e]._oldVal;t.options[a]=i}var n=this._layer._getDrawer(t.drawType);n.setDrawOptions(t.options),this._layer.draw(),t.initController()}},util.inherits(Drawer,Class),Drawer.prototype.beginDrawMap=function(){"2d"==this.getLayer().getContext()&&this.beginDrawCanvasMap()},Drawer.prototype.endDrawMap=function(){"2d"==this.getLayer().getContext()&&this.endDrawCanvasMap()},Drawer.prototype.beginDrawCanvasMap=function(){var t=this.getDrawOptions(),e=this.getCtx(),a=util.getPixelRatio(e);this._elementPaths=[],e.save(),e.scale(a,a);for(var i=["globalCompositeOperation","shadowColor","shadowBlur","shadowOffsetX","shadowOffsetY","globalAlpha","fillStyle","strokeStyle","lineWidth","lineCap","lineJoin","lineWidth","miterLimit"],n=0;n<i.length;n++)t[i[n]]&&(e[i[n]]=t[i[n]])},Drawer.prototype.endDrawCanvasMap=function(){var t=this.getCtx();t.restore()},Drawer.prototype.drawOptions_changed=function(){var t=this.getDrawOptions();t&&t.splitList?this.splitList=t.splitList:this.generalSplitList()},Drawer.prototype.colors=["rgba(17, 102, 252, 0.8)","rgba(52, 139, 251, 0.8)","rgba(110, 176, 253, 0.8)","rgba(255, 241, 193, 0.8)","rgba(255, 146, 149, 0.8)","rgba(253, 98, 104, 0.8)","rgba(255, 0, 0, 0.8)","rgba(255, 51, 61, 0.8)"],Drawer.prototype.generalSplitList=function(){var t=this.getLayer().getDataRange(),e=Math.ceil((t.max-t.min)/7),a=t.min;this.splitList=[];for(var i=1;a<t.max;)this.splitList.push({start:a,end:a+e,size:i,color:this.colors[i-1]}),a+=e,i++},Drawer.prototype.getRadius=function(){var t=this.getMap().getZoom(),e=Math.pow(2,18-t),a=this.getDrawOptions(),i=parseFloat(a.size)||13,n=a.unit||"px";return"m"===n?i/=e:i=i,a.minPxSize&&i<a.minPxSize&&(i=a.minPxSize),i},Drawer.prototype.getElementPaths=function(){return this._elementPaths},util.inherits(BubbleDrawer,Drawer),BubbleDrawer.prototype.drawMap=function(t){this.beginDrawMap();var e=this.getLayer().getData(),a=this.getHighlightElement(),i=this.getCtx(),n=this.getDrawOptions(),r=1+.2*(this.getMap().getZoom()-6),o=!0;void 0!==t&&(r*=t,i.globalAlpha=t,1>t&&(o=!1));for(var s=0,l=e.length;l>s;s++){var h=e[s],p=this.dataRange.getSize(h.count),g=new Path2D;p=Math.round(r*p),1>p&&(p=1),g.arc(h.px,h.py,p,0,2*Math.PI,!1),o&&this._elementPaths.push(g),a&&a.index==s||(i.save(),i.fill(g),n.strokeStyle&&i.stroke(g),i.restore())}if(a){var d=this._elementPaths[a.index];if(i.fill(d),n.highlightStrokeStyle){a.data;i.save(),i.strokeStyle=n.highlightStrokeStyle,i.beginPath(),i.stroke(d),i.restore()}else n.strokeStyle&&i.stroke(d)}this.endDrawMap()},util.inherits(CategoryDrawer,Drawer),CategoryDrawer.prototype.drawMap=function(){this.beginDrawMap();for(var t=this.getLayer().getData(),e=this.getCtx(),a=this.getDrawOptions(),i=this.getRadius(),n=0,r=t.length;r>n;n++){var o=t[n];e.beginPath(),e.moveTo(o.px,o.py),e.fillStyle=this.dataRange.getCategoryColor(o.count),e.arc(o.px,o.py,i,0,2*Math.PI),e.closePath(),e.fill()}a.strokeStyle&&e.stroke(),this.endDrawMap()},util.inherits(ChoroplethDrawer,Drawer),ChoroplethDrawer.prototype.drawMap=function(){this.beginDrawMap();var t=this.getLayer().getData(),e=this.getLayer().getDataType(),a=this.getCtx(),i=this.getDrawOptions(),n=i.label,r=this.getMap().getZoom();if(n&&n.font&&(a.font=n.font),"polyline"===e||"polygon"===e)for(var o=0,s=t.length;s>o;o++){var l=t[o].pgeo;a.beginPath(),a.moveTo(l[0][0],l[0][1]);for(var h=1;h<l.length;h++)a.lineTo(l[h][0],l[h][1]);if(a.fillStyle=this.dataRange.getColorByRange(t[o].count),(i.strokeStyle||"polyline"===e)&&a.stroke(),"polygon"===e&&(a.closePath(),a.fill()),n&&n.show&&(!n.minZoom||n.minZoom&&r>=n.minZoom)){n.fillStyle&&(a.fillStyle=n.fillStyle);var p=util.getGeoCenter(l);a.fillText(t[o].count,p[0],p[1])}}else{for(var g=this.getRadius(),o=0,s=t.length;s>o;o++){var d=t[o];a.fillStyle=this.dataRange.getColorByRange(d.count),a.beginPath(),a.moveTo(d.px,d.py),a.arc(d.px,d.py,g,0,2*Math.PI),a.closePath(),a.fill()}i.strokeStyle&&a.stroke()}this.endDrawMap()};var min,max;util.inherits(ClusterDrawer,Drawer),ClusterDrawer.prototype.drawMap=function(){this.beginDrawMap();var t=this.getCtx();max=min=void 0;for(var e=this.getLayer().getData(),a=this.getMapv().getMap(),i=a.getZoom(),n=this.zoomUnit=Math.pow(2,18-i),r=this.formatParam(),o=r.size,s=a.getMapType().getProjection(),l=s.lngLatToPoint(a.getCenter()),h=l.x-a.getSize().width/2*n,p=new BMap.Pixel(h,l.y+a.getSize().height/2*n),g=o/n,d=parseInt(p.x/o,10)*o,c=(d-p.x)/n,u=[],f=0;c+f*g<a.getSize().width;){var m=c+f*g;u.push(m.toFixed(2)),f++}for(var y=parseInt(p.y/o,10)*o+o,v=(p.y-y)/n,w=[],x=0;v+x*g<a.getSize().height;)m=v+x*g,w.push(m.toFixed(2)),x++;for(var _={},b=0;b<u.length;b++)for(var C=0;C<w.length;C++){var D=u[b]+"_"+w[C];_[D]=0}for(var b=0;b<e.length;b++){var T=e[b].px,S=e[b].py,M=parseInt(e[b].count,10),P=T<u[0],O=S<w[0],L=T>Number(u[u.length-1])+Number(g),R=S>Number(w[w.length-1])+Number(g);if(!(P||O||L||R)){for(var C=0;C<u.length;C++){var I=Number(u[C]);if(T>=I&&I+g>T)for(var E=0;E<w.length;E++){var z=Number(w[E]);S>=z&&z+g>S&&(_[u[C]+"_"+w[E]]+=M,M=_[u[C]+"_"+w[E]])}}min=min||M,max=max||M,min=min>M?M:min,max=M>max?M:max}}var A=(max-min+1)/10;for(var b in _){var k=b.split("_");T=Number(k[0]),S=Number(k[1]);var B=(_[b]-min)/A;B=0>B?0:B;var N=T+g/2,F=S+g/2;t.fillStyle=r.fillStyle||"#fa8b2e",t.beginPath(),t.arc(N,F,5*B,0,2*Math.PI),t.fill(),t.lineWidth=8*B/10,t.strokeStyle=r.strokeStyle||"#fff",t.stroke(),t.save(),t.font=30*B/10+"px serif",t.textAlign="center",t.textBaseline="middle",0!==_[b]&&r.label.show&&(t.fillStyle="#fff",t.fillText(_[b],N,F),t.restore())}this.endDrawMap()},ClusterDrawer.prototype.formatParam=function(){var t=this.getDrawOptions();t=JSON.stringify(t),t=JSON.parse(t);var e=t.size||60;return e+=t.unit||"px",e=/px$/.test(e)?parseInt(e,10)*this.zoomUnit:parseInt(e,10),t.size=e,t};var min,max;util.inherits(DensityDrawer,Drawer),DensityDrawer.prototype.scale=function(t){var e=this;t.change(function(t,a){e.masker={min:t,max:a},e.ctx=e.getCtx(),e.ctx.clearRect(0,0,e.ctx.canvas.width,e.ctx.canvas.height),e.drawMap()}),this.Scale=t},DensityDrawer.prototype.drawMap=function(){this.beginDrawMap();var t=this,e=this.getCtx(),a=this.getLayer().getData(),i=this.getMapv().getMap(),n=i.getZoom(),r=this.zoomUnit=Math.pow(2,18-n),o=formatParam.call(this),s=o.size,l=i.getMapType().getProjection(),h=l.lngLatToPoint(i.getCenter()),p=h.x-i.getSize().width/2*r,g=new BMap.Pixel(p,h.y+i.getSize().height/2*r),d={data:a,nwMc:g,size:s,zoomUnit:r,ctx:e},c={};c="honeycomb"===this.getDrawOptions().type?honeycombGrid(d):recGrids(d,i);var u=c.grids;this.dataRange.setMax(c.max),this.dataRange.setMin(c.min);var f=c.max,m=c.min,d={size:s,zoomUnit:r,max:f,min:m,ctx:e,grids:u,fillColors:o.colors,dataRange:this.dataRange,sup:t},c={};"honeycomb"===this.getDrawOptions().type?drawHoneycomb.call(this,d):drawRec.call(this,d),this.Scale&&this.Scale.set({max:f,min:m,colors:this.getDrawOptions().gradient||"default"}),this.endDrawMap()};var r=0,g=0,b=0;util.inherits(HeatmapDrawer,Drawer),HeatmapDrawer.prototype.drawMap=function(){var t=this;t.Scale&&t.Scale.set({min:0,max:t.getMax(),colors:this.getGradient()}),this.beginDrawMap();var e=this.getCtx();this._width=e.canvas.width,this._height=e.canvas.height;var a=this.getLayer().getData();this._data=a,this._width>0&&this._height>0&&this.drawHeatmap(),this.endDrawMap()},HeatmapDrawer.prototype.scale=function(t){var e=this;t.change(function(t,a){e.masker={min:t,max:a},e.drawMap()}),e.Scale=t},util.extend(HeatmapDrawer.prototype,{defaultRadius:10,defaultGradient:{.4:"blue",.6:"cyan",.7:"lime",.8:"yellow","1.0":"red"},getGradient:function(){return this.getDrawOptions().gradient||this.defaultGradient},getMax:function(){var t=this._max;if(void 0!==this.getDrawOptions().max)t=this.getDrawOptions().max;else{var e=this.getLayer().getDataRange();t=e.min+.7*(e.max-e.min)}return t},data:function(t){return this._data=t,this},max:function(t){return this._max=t,this},add:function(t){return this._data.push(t),this},clear:function(){return this._data=[],this},radius:function(t){var e=this._circle=document.createElement("canvas"),a=e.getContext("2d"),i=0;i=void 0!==this.getDrawOptions().shadowBlur?parseFloat(this.getDrawOptions().shadowBlur):0;var n=this._r=t+i;"rect"===this.getDrawOptions().type?e.width=e.height=n:e.width=e.height=2*n;var r;if(void 0!==this.getDrawOptions().shadowBlur)a.shadowBlur=i,a.shadowColor="black",r=1e4;else{r=0;var o=a.createRadialGradient(n-r,n-r,0,n-r,n-r,t);o.addColorStop(0,"rgba(0, 0, 0, 1)"),o.addColorStop(1,"rgba(0, 0, 0, 0)"),a.fillStyle=o}return a.shadowOffsetX=a.shadowOffsetY=r,a.beginPath(),"rect"===this.getDrawOptions().type?a.fillRect(-r,-r,e.width,e.height):a.arc(n-r,n-r,t,0,2*Math.PI,!0),a.closePath(),a.fill(),this},drawHeatmap:function(t){this.radius(this.getRadius());var e=this.getCtx();e.save(),e.clearRect(0,0,this._width,this._height);var a=this.getLayer().getDataType(),i=this.getMax();if("polyline"===a){e.strokeStyle=this.getDrawOptions().strokeStyle||"rgba(0, 0, 0, 0.8)",e.lineWidth=this.getDrawOptions().lineWidth||1,e.beginPath();for(var n=0,r=this._data.length;r>n;n++){l=this._data[n];var o=l.pgeo;e.beginPath(),e.moveTo(o[0][0],o[0][1]);for(var s=1;s<o.length;s++)e.lineTo(o[s][0],o[s][1]);e.globalAlpha=Math.max(l.count/i,void 0===t?.05:t),e.stroke()}}else for(var l,h=this.getDrawOptions().boundary||this._circle.width+50,n=0,r=this._data.length;r>n;n++)l=this._data[n],l.px<-h||l.py<-h||l.px>e.canvas.width+h||l.py>e.canvas.height+h,e.globalAlpha=Math.max(l.count/i,void 0===t?.05:t),e.drawImage(this._circle,l.px-this._r,l.py-this._r);var p=e.getImageData(0,0,this._width,this._height);return this.colorize(p.data,this.dataRange.getGradient()),e.putImageData(p,0,0),e.restore(),this},colorize:function(t,e){var a=0,i=1024;this.masker.min&&(a=this.masker.min/this.getMax()*1024),this.masker.max&&(i=this.masker.max/this.getMax()*1024);for(var n,r=this.getDrawOptions().maxOpacity||.8,o=3,s=t.length;s>o;o+=4)n=4*t[o],t[o]/256>r&&(t[o]=256*r),n&&n>=a&&i>=n?(t[o-3]=e[n],t[o-2]=e[n+1],t[o-1]=e[n+2]):t[o]=0}}),util.inherits(IntensityDrawer,Drawer),IntensityDrawer.prototype.defaultGradient={"0.0":"yellow","1.0":"red"},IntensityDrawer.prototype.drawMap=function(){this.Scale&&this.Scale.set({min:0,max:this.getMax(),colors:this.getGradient()}),this.dataRange.setMax(this.getMax()),this.beginDrawMap();var t=this,e=this.getCtx();e.clearRect(0,0,e.canvas.width,e.canvas.height);var a=this.getLayer().getData(),i=this.getDrawOptions();e.strokeStyle=i.strokeStyle;var n=e.canvas.width,r=e.canvas.height,o=this.getRadius(),s=this.getLayer().getDataType(),l=i.label,h=this.getMap().getZoom();if(l&&l.font&&(e.font=l.font),"polygon"===s||"polyline"===s)for(var p=0,g=a.length;g>p;p++){var d=a[p],c=d.pgeo,u=t.masker.min&&d.count<t.masker.min,f=t.masker.max&&d.count>t.masker.max;if(!u&&!f){e.beginPath(),e.moveTo(c[0][0],c[0][1]),e.fillStyle=this.dataRange.getColorByGradient(a[p].count);for(var m=1;m<c.length;m++)e.lineTo(c[m][0],c[m][1]);if("polygon"==s&&(e.closePath(),e.fill()),"polyline"==s?(e.strokeStyle=this.dataRange.getColorByGradient(a[p].count),e.stroke()):i.strokeStyle&&e.stroke(),l&&l.show&&(!l.minZoom||l.minZoom&&h>=l.minZoom)){l.fillStyle&&(e.fillStyle=l.fillStyle);var y=util.getGeoCenter(c);e.fillText(a[p].count,y[0],y[1])}}}else for(var p=0,g=a.length;g>p;p++){var d=a[p];if(!(d.px<0||d.px>n||d.py<0||d.py>r)){var u=t.masker.min&&d.count<t.masker.min,f=t.masker.max&&d.count>t.masker.max;u||f||(e.beginPath(),e.moveTo(d.px,d.py),e.fillStyle=this.dataRange.getColorByGradient(d.count),e.arc(d.px,d.py,o||1,0,2*Math.PI),e.closePath(),e.fill())}}i.strokeStyle&&e.stroke(),this.endDrawMap()},IntensityDrawer.prototype.getGradient=function(){return this.getDrawOptions().gradient||this.defaultGradient},IntensityDrawer.prototype.scale=function(t){var e=this;t.change(function(t,a){e.masker={min:t,max:a},e.drawMap()}),e.Scale=t},IntensityDrawer.prototype.getMax=function(){var t=this.getLayer().getDataRange(),e=t.max;return this.getDrawOptions().max&&(e=this.getDrawOptions().max),e},util.inherits(LineDrawer,Drawer),LineDrawer.prototype.drawMap=function(t){this.beginDrawMap();var e=this.getCtx(),a=this.getLayer().getData(),i=this.getMapv().getMap(),n=i.getZoom(),r=this.zoomUnit=Math.pow(2,18-n),o=formatParam.call(this),s=(o.size,i.getMapType().getProjection()),l=s.lngLatToPoint(i.getCenter()),h=l.x-i.getSize().width/2*r;new BMap.Pixel(h,l.y+i.getSize().height/2*r);e.globalCompositeOperation="lighter",e.strokeStyle="rgba(100,100,10,0.4)",e.lineWidth=.8;for(var p=0,g=a.length;g>p;p++){e.beginPath();var d=a[p].pgeo;e.moveTo(d[0][0],d[0][1]);for(var c=1;c<d.length;c++)d[c][0]<-100&&d[c][1]<-100||e.lineTo(d[c][0],d[c][1]);e.stroke()}this.endDrawMap()},util.inherits(SimpleDrawer,Drawer),SimpleDrawer.prototype.drawMap=function(t){var e=this.getLayer().getDataType();if("webgl"===this.getLayer().getContext())return void("polyline"===e?this.drawWebglPolyline():this.drawWebglPoint());this.beginDrawMap();var a=this.getLayer().getData(),i=this.getCtx(),n=this.getDrawOptions();if(i.beginPath(),"polyline"===e||"polygon"===e){var r=n.label,o=this.getMap().getZoom();if(r){r.font&&(i.font=r.font);var s=r.key||"count"}for(var l=this.getLayer().getAnimationOptions()||{},h=0,p=a.length;p>h;h++){var g=a[h].pgeo,d=0,c=g.length-1;if(t)for(var u=l.scope||10800,f=0;f<g.length&&(parseFloat(g[f][2])<t-u&&(d=f),c=f,!(parseFloat(g[f][2])>t));f++);if(!(d>=c)){i.beginPath(),i.moveTo(g[d][0],g[d][1]);for(var f=d+1;c>=f;f++)i.lineTo(g[f][0],g[f][1]);if((n.strokeStyle||"polyline"===e)&&i.stroke(),"polygon"===e&&(i.closePath(),i.fill()),r&&r.show&&(!r.minZoom||r.minZoom&&o>=r.minZoom)){i.save(),r.fillStyle&&(i.fillStyle=r.fillStyle);var m=util.getGeoCenter(g);i.fillText(a[h][s],m[0],m[1]),i.restore()}}}}else if(!n.scaleRange&&this.getRadius()<2){for(var y=this.getRadius(),h=0,p=a.length;p>h;h++){var v=a[h];v.px<0||v.px>i.canvas.width||v.py<0||v>i.canvas.height||(i.moveTo(v.px,v.py),i.arc(v.px,v.py,y,0,2*Math.PI,!1))}i.fill()}else{void 0==t&&(t=1);var w=1>t?!1:!0;i.globalAlpha=t;for(var h=0,p=a.length;p>h;h++){var v=a[h],x=new Path2D,_=n.scaleRange?Math.sqrt(this.dataRange.getScale(v.count)):1;if(_*=t,n.icon){if(n.scaleRange){var b=util.copy(n.icon);b.width*=_,b.height*=_,b.offsetX=b.offsetX?b.offsetX*_:0,b.offsetY=b.offsetY?b.offsetY*_:0}this.drawIcon(i,v,b);var C=b.offsetX,D=b.offsetY,T=b.width||0,S=b.height||0,x=new Path2D,M=v.px-T/2-C,P=v.py-S/2-D;x.rect(M,P,T,S)}else{var y=this.getRadius()*_,O=v.shape||n.shape||"circle";switch(O){case"rect":x.moveTo(v.px-y,v.px-y),x.rect(v.px-y,v.py-y,2*y,2*y);break;case"triangle":x.moveTo(v.px,v.py-y),x.lineTo(v.px-y*Math.sqrt(3)/2,v.py+y/2),x.lineTo(v.px+y*Math.sqrt(3)/2,v.py+y/2),x.lineTo(v.px,v.py-y);break;case"diamond":x.moveTo(v.px,v.py-1.5*y),x.lineTo(v.px-y,v.py),x.lineTo(v.px,v.py+1.5*y),x.lineTo(v.px+y,v.py),x.lineTo(v.px,v.py-1.5*y);break;case"circle":default:x.moveTo(v.px,v.py),x.arc(v.px,v.py,y,0,2*Math.PI,!1)}i.save(),v.color&&(i.fillStyle=v.color),i.fill(x),n.strokeStyle&&i.stroke(x),i.restore()}w&&this._elementPaths.push(x)}}this.endDrawMap()},SimpleDrawer.prototype.drawIcon=function(t,e,a){var i=this,n=new Image;!function(e,a){n.onload=function(){var r=a.width||0,o=a.height||0,s=e.color||a.color;if(s){var s=s.replace("rgba(","").replace(")","").split(","),l=document.createElement("canvas"),h=l.getContext("2d"),p=2;l.width=r*p,l.height=o*p,h.drawImage(n,0,0,l.width,l.height);for(var g=h.getImageData(0,0,l.width,l.height),d=g.data,c=0;c<d.length;c+=4){var u=d[c+0],f=d[c+1],m=d[c+2],y=d[c+3];100>y||u>200&&f>200&&m>200||(d[c+0]=parseInt(s[0]),d[c+1]=parseInt(s[1]),d[c+2]=parseInt(s[2]))}h.putImageData(g,0,0),i.drawImage(t,e,a,l)}else i.drawImage(t,e,a,n)}}(e,a),n.src=a.url},SimpleDrawer.prototype.drawImage=function(t,e,a,i){var n=a.width||0,r=a.height||0,o=a.offsetX||0,s=a.offsetY||0,l=util.getPixelRatio(t),h=e.px-n/2-o,p=e.py-r/2-s;t.save(),t.scale(l,l),t.drawImage(i,h,p,n,r),t.restore()},SimpleDrawer.prototype.drawAnimation=function(){var t=this.getLayer(),e=t.getData(),a=t.getDataType(),i=t.getAnimationOptions(),n=t.getAnimation(),r=t.getAnimationCtx();if("polyline"===a)if("time"===n);else for(var o=0,s=e.length;s>o;o++){var l=e[o].index,h=e[o].pgeo,p=util.getPixelRatio(r);r.save(),r.scale(p,p);var g=h[l][0],d=h[l][1],c=r.createRadialGradient(g,d,0,g,d,i.size);c.addColorStop(0,"rgba(255, 255, 255, 1)"),c.addColorStop(.4,"rgba(255, 255, 255, 0.9)"),c.addColorStop(1,"rgba(255, 255, 255, 0)"),r.fillStyle=c,r.beginPath(),r.arc(g,d,i.size,0,2*Math.PI,!1),r.closePath(),r.fill(),e[o].index++,e[o].index>=e[o].pgeo.length&&(e[o].index=0),r.restore()}},SimpleDrawer.prototype.drawWebglPoint=function(){var t=this.getLayer().getData();if(t){var e,a,i,n,r=this.getCtx();e=r.createShader(r.VERTEX_SHADER),a=r.createShader(r.FRAGMENT_SHADER),i=["attribute vec4 a_Position;","attribute float a_PointSize;","void main() {","gl_Position = a_Position;","gl_PointSize = a_PointSize;","}"].join(""),n=["precision mediump float;","uniform vec4 u_FragColor;","void main() {","gl_FragColor = u_FragColor;","}"].join("");var o=r.createProgram();r.shaderSource(e,i),r.compileShader(e),r.shaderSource(a,n),r.compileShader(a),r.attachShader(o,e),r.attachShader(o,a),r.linkProgram(o),r.useProgram(o);var s=r.getAttribLocation(o,"a_Position"),l=r.getAttribLocation(o,"a_PointSize"),h=r.getUniformLocation(o,"u_FragColor");r.clear(r.COLOR_BUFFER_BIT);for(var p=r.canvas.width/2,g=r.canvas.height/2,d=[],c=0,u=0;u<t.length;u++){var f=t[u],m=(f.px-p)/p,y=(g-f.py)/g;-1>m||m>1||-1>y||y>1||(d.push(m,y),c++)}var v=new Float32Array(d),w=c,x=r.createBuffer();if(!x)return-1;r.bindBuffer(r.ARRAY_BUFFER,x),r.bufferData(r.ARRAY_BUFFER,v,r.STATIC_DRAW);var s=r.getAttribLocation(o,"a_Position");if(0>s)return-1;r.vertexAttribPointer(s,2,r.FLOAT,!1,0,0),r.enableVertexAttribArray(s),r.vertexAttrib1f(l,this.getRadius());var _=document.createElement("canvas"),b=_.getContext("2d");_.width=1,_.height=1,b.fillStyle=this.getDrawOptions().fillStyle,b.fillRect(0,0,1,1);var C=b.getImageData(0,0,1,1).data;r.uniform4f(h,C[0]/255,C[1]/255,C[2]/255,C[3]/255),r.drawArrays(r.POINTS,0,w)}},SimpleDrawer.prototype.drawWebglPolyline=function(){var t=this.getLayer().getData();if(t){var e,a,i,n,r=this.getCtx();e=r.createShader(r.VERTEX_SHADER),a=r.createShader(r.FRAGMENT_SHADER),i=["attribute vec4 a_Position;","void main() {","gl_Position = a_Position;","gl_PointSize = 30.0;","}"].join(""),n=["precision mediump float;","uniform vec4 u_FragColor;","void main() {","gl_FragColor = u_FragColor;","}"].join("");var o=r.createProgram();r.shaderSource(e,i),r.compileShader(e),r.shaderSource(a,n),r.compileShader(a),r.attachShader(o,e),r.attachShader(o,a),r.linkProgram(o),r.useProgram(o),r.enable(r.BLEND),r.blendFunc(r.SRC_ALPHA,r.ONE),r.clear(r.COLOR_BUFFER_BIT);var s=r.canvas.width/2,l=r.canvas.height/2,h=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,h);var p=r.getAttribLocation(o,"a_Position");r.vertexAttribPointer(p,2,r.FLOAT,!1,0,0),r.enableVertexAttribArray(p);var g=r.getUniformLocation(o,"u_FragColor"),d=document.createElement("canvas"),c=d.getContext("2d");d.width=1,d.height=1,c.fillStyle=this.getDrawOptions().strokeStyle||"red",c.fillRect(0,0,1,1);var u=c.getImageData(0,0,1,1).data;r.uniform4f(g,u[0]/255,u[1]/255,u[2]/255,u[3]/255),r.lineWidth(this.getDrawOptions().lineWidth||1);for(var f=0,m=t.length;m>f;f++){for(var y=t[f].pgeo,v=[],w=0;w<y.length;w++){var x=y[w],_=(x[0]-s)/s,b=(l-x[1])/l;v.push(_,b)}var C=new Float32Array(v);r.bufferData(r.ARRAY_BUFFER,C,r.STATIC_DRAW),r.drawArrays(r.LINE_STRIP,0,y.length)}}},Mapv.Layer=Layer,window.Mapv=Mapv}();